<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyFaaS Admin Dashboard</title>
    <style>
        /* ESTILOS BASE */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        /* Se ajusta el width de los inputs para evitar conflictos al centrar el bot√≥n */
        input[type="text"], input[type="file"], button { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; width: calc(100% - 10px); box-sizing: border-box; }
        input[type="file"] { width: auto; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; margin-right: 5px; width: auto; }
        button:hover { background-color: #0056b3; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-logs { background-color: #28a745; }
        .btn-logs:hover { background-color: #1e7e34; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        /* üöÄ CAMBIO CLAVE: Estilos para tabla m√°s compacta y legible */
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; }
        th { background-color: #f2f2f2; }
        
        /* Estilos para el formulario en una sola fila (FLEXBOX) */
        .form-row {
            display: flex;
            gap: 10px; /* Espacio entre los elementos de la fila */
            margin-bottom: 15px;
        }

        .form-field {
            flex-grow: 1; /* Ocupa el espacio disponible de manera uniforme */
            min-width: 0; /* Permite que el contenido se encoja correctamente */
        }
        
        /* Ajuste para que los inputs dentro de form-field ocupen el 100% de su contenedor */
        .form-field input[type="text"],
        .form-field input[type="file"] {
            width: 100%;
            margin: 0;
            padding: 8px;
        }

        /* Estilo espec√≠fico para el bot√≥n de despliegue (ID) */
        #deploy-button {
            width: 60%; 
            max-width: 300px; 
            font-size: 1em;
            padding: 10px; 
            background-color: #007bff;
            margin: 20px auto 0; 
            display: block; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        #deploy-button:hover {
            background-color: #0056b3;
        }

        /* ESTILO MEJORADO: STATUS BOX (FLEX/CARDS) */
        .status-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            border-radius: 8px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
        }

        .status-metric {
            background-color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            flex-grow: 1;
            min-width: 130px; 
            text-align: center;
        }

        .metric-label {
            font-size: 0.8em;
            color: #555;
            margin-bottom: 3px;
            display: block;
        }

        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        
        /* Colores para alertas de m√©tricas */
        .metric-value.good { color: #28a745; } 
        .metric-value.warn { color: #ffc107; } 
        .metric-value.danger { color: #dc3545; } 

        /* ESTILOS DE TAREAS AS√çNCRONAS Y CONSOLA */
        #console-output {
            background-color: #1e1e1e;
            color: #cccccc;
            padding: 15px;
            height: 250px;
            overflow-y: scroll;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            margin-top: 20px;
            border: 1px solid #333;
        }
        .console-entry { border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }

        /* ESTILOS DE BOTONES MODIFICADOS */
        .btn-async {
            background-color: #ff8c00; 
            color: white;
        }
        .btn-async:hover {
            background-color: #cc7000; 
        }

        /* Bot√≥n ic√≥nico en la tabla de tareas */
        .btn-icon {
            padding: 5px 8px; 
            width: auto;
            font-size: 14px;
            margin-left: 2px;
            min-width: 30px; 
        }
        /* Bot√≥n de Borrar Todo */
        .btn-delete-all {
            background-color: #dc3545; 
            margin-left: 15px;
        }
        .btn-delete-all:hover {
            background-color: #c82333;
        }
        
        /* CLASES DE COLOR PARA ESTADO */
        .console-entry.info, strong.info { color: #cccccc; }
        .console-entry.success, strong.success { color: #00ff41; }
        .console-entry.error, strong.error { color: #ff3333; }
        .console-entry.warning, strong.warning { color: #ffdd00; }
        .console-entry.queued, strong.queued { color: #17a2b8; } 
        .console-entry.running, strong.running { color: #ffc107; } 
        .console-entry.completed, strong.completed { color: #00ff41; } 
        .console-entry.failed, strong.failed { color: #ff3333; } 
    </style>
</head>
<body>

<div class="container">
    <h1>Administraci√≥n de TinyFaaS</h1>

    <div class="status-box" id="server-status-container">Cargando estado...</div>

    <h2>Desplegar Nueva Funci√≥n</h2>
    <form id="upload-form">
        <div class="form-row">
            
            <div class="form-group form-field">
                <label for="name">üìù Nombre (Opcional):</label>
                <input type="text" id="name" name="name" placeholder="ej. mi_funcion" title="Si se deja vac√≠o, se usa el nombre del archivo.">
                <small style="color: #6c757d;">Nombre de invocaci√≥n √∫nico.</small>
            </div>

            <div class="form-group form-field">
                <label for="code">üìÇ C√≥digo (*.py, *.js, *.c):</label>
                <input type="file" id="code" name="code" accept=".py, .js, .c" required>
                <small style="color: #007bff;">Debe contener la funci√≥n `main(*args)`.</small>
            </div>

            <div class="form-group form-field">
                <label for="requirements">üîó Dependencias (requirements.txt):</label>
                <input type="file" id="requirements" name="requirements" accept=".txt, .json">
                <small style="color: #6c757d;">Para reconstruir la imagen base.</small>
            </div>
            
        </div>
        
        <div style="text-align: center; margin-top: 10px;">
             <button type="submit" id="deploy-button">üöÄ Desplegar Funci√≥n</button>
        </div>
    </form>

    <h2>Funciones Desplegadas</h2>
    <table id="functions-table">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Fecha Despliegue</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="functions-list">
            </tbody>
    </table>

    <h2 style="margin-top: 40px;">Monitor de Tareas As√≠ncronas</h2>
    <div>
        <button onclick="listAsyncTasks()">Recargar Tareas</button>
        <button onclick="clearAllAsyncTasks()" class="btn-delete-all">üóëÔ∏è Borrar Todas las Tareas</button>
    </div>
    <table id="tasks-table">
        <thead>
            <tr>
                <th>ID Tarea</th>
                <th>Funci√≥n</th>
                <th>Estado</th>
                <th>Tiempo Inicio</th>
                <th>Tiempo Fin</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="async-tasks-list">
        </tbody>
    </table>
    <h2 style="margin-top: 40px;">Consola de Operaciones</h2>
    <div id="console-output">
        Listo para operar.
    </div>

</div>

<script>
    // Configuraci√≥n de Autenticaci√≥n (Debe coincidir con el servidor)
    const ADMIN_USER = 'admin';
    const ADMIN_PASS = '1234';
    const authHeader = 'Basic ' + btoa(`${ADMIN_USER}:${ADMIN_PASS}`);
    const consoleOutput = document.getElementById('console-output');

    document.addEventListener('DOMContentLoaded', () => {
         getServerStatus();
        listFunctions();
        listAsyncTasks(); 
        document.getElementById('upload-form').addEventListener('submit', handleUpload);
        
        // Intervalo de actualizaci√≥n del estado del servidor (5 minutos)
        const serverIntervalMs = 5 * 60 * 1000; 
        console.log(`[INFO] La actualizaci√≥n autom√°tica del estado del servidor est√° activa cada ${serverIntervalMs / 1000 / 60} minutos.`);
        setInterval(getServerStatus, serverIntervalMs);

        // Intervalo de actualizaci√≥n del monitor de tareas (cada 30 segundos)
        const taskIntervalMs = 30000; 
        console.log(`[INFO] El monitor de tareas as√≠ncronas se actualizar√° autom√°ticamente cada ${taskIntervalMs / 1000} segundos.`);
        setInterval(listAsyncTasks, taskIntervalMs); 
    });
    
    // =======================================================
    // CONSOLA
    // =======================================================
    function logToConsole(message, type = 'info', funcName = '', operation = '') { 
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = `console-entry ${type}`;
        
        const namePrefix = funcName ? `[${funcName}] ` : '';
        const opPrefix = operation ? `<${operation}> ` : ''; 
        
        const logMessage = typeof message === 'string' ? message : JSON.stringify(message, null, 2);
        
        entry.textContent = `[${timestamp}] ${opPrefix}${namePrefix}${logMessage}`; 
        
        consoleOutput.prepend(entry); 
        while (consoleOutput.children.length > 100) {
            consoleOutput.removeChild(consoleOutput.lastChild);
        }
    }


    // =======================================================
    // 1. GESTI√ìN DEL ESTADO DEL SERVIDOR
    // =======================================================
    function getServerStatus() {
        fetch('/admin/status', {
            headers: { 'Authorization': authHeader }
        })
        .then(response => response.json())
        .then(data => {
            const statusContainer = document.getElementById('server-status-container');
            
            // Determinar clases de color para m√©tricas
            const cpuClass = data.cpu_percent > 80 ? 'danger' : data.cpu_percent > 50 ? 'warn' : 'good';
            const ramClass = data.ram_percent > 85 ? 'danger' : data.ram_percent > 60 ? 'warn' : 'good';

            // Rellenar el contenedor con las cards de m√©tricas
            statusContainer.innerHTML = `
                <div class="status-metric">
                    <span class="metric-label">Estado del Servidor</span>
                    <span class="metric-value ${data.status === 'ok' ? 'good' : 'danger'}">${data.status.toUpperCase()}</span>
                </div>
                <div class="status-metric">
                    <span class="metric-label">CPU (Uso)</span>
                    <span class="metric-value ${cpuClass}">${data.cpu_percent}%</span>
                </div>
                <div class="status-metric">
                    <span class="metric-label">RAM (Uso)</span>
                    <span class="metric-value ${ramClass}">${data.ram_percent}%</span>
                </div>
                <div class="status-metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value">${data.uptime}</span>
                </div>
                <div class="status-metric">
                    <span class="metric-label">Funciones Cargadas</span>
                    <span class="metric-value">${data.loaded_functions}</span>
                </div>
                <div class="status-metric">
                    <span class="metric-label">Tareas Activas</span>
                    <span class="metric-value">${data.async_tasks_running || 0}</span>
                </div>
            `;
            
            statusContainer.style.backgroundColor = data.status === 'ok' ? '#e6f7ff' : '#fff0f6';
            logToConsole(`Estado del servidor actualizado: CPU ${data.cpu_percent}%, RAM ${data.ram_percent}%`, 'info', '', 'SERVER_STATUS_OK');
        })
        .catch(error => {
            logToConsole('Error al obtener estado del servidor. Revise la conexi√≥n.', 'error', '', 'SERVER_STATUS_ERROR');
            document.getElementById('server-status-container').innerHTML = 'Error al conectar con el servidor.';
        });
    }

    // =======================================================
    // 2. DESPLIEGUE, LISTADO, ELIMINACI√ìN e INVOCACI√ìN
    // =======================================================

    function handleUpload(event) {
        event.preventDefault();
        
        const form = document.getElementById('upload-form');
        const formData = new FormData(form);
        logToConsole('Iniciando despliegue. Puede tardar si hay dependencias...', 'info', '', 'DEPLOY');

        fetch('/admin/upload', {
            method: 'POST',
            headers: { 'Authorization': authHeader },
            body: formData
        })
        .then(response => response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.message || `Error ${response.status} en la API.`);
            }
            return data;
        }))
        .then(data => {
            logToConsole(`√âxito: ${data.message}`, 'success', '', 'DEPLOY_RESULT');
            form.reset();
            listFunctions(); 
            getServerStatus(); 
        })
        .catch(error => {
            logToConsole(`Fallo al desplegar: ${error.message}`, 'error', '', 'DEPLOY_ERROR');
            console.error('Error de Despliegue:', error);
        });
    }

    function listFunctions() {
        fetch('/admin/functions', {
            headers: { 'Authorization': authHeader }
        })
        .then(response => response.json())
        .then(functions => {
            const funcListBody = document.getElementById('functions-list');
            funcListBody.innerHTML = ''; 

            for (const name in functions) {
                const data = functions[name];
                const row = funcListBody.insertRow();
                
                row.insertCell().textContent = name;
                row.insertCell().textContent = data.created_at;
                
                const actionsCell = row.insertCell();

                // Bot√≥n Invocar SINCRONO
                const invokeSyncBtn = document.createElement('button');
                invokeSyncBtn.textContent = 'Invocar (SYNC)';
                invokeSyncBtn.title = 'Ejecuci√≥n s√≠ncrona (espera resultado).';
                invokeSyncBtn.onclick = () => promptInvoke(name, 'sync');
                actionsCell.appendChild(invokeSyncBtn);

                // Bot√≥n Invocar AS√çNCRONO
                const invokeAsyncBtn = document.createElement('button');
                invokeAsyncBtn.textContent = 'Invocar (ASYNC)';
                invokeAsyncBtn.className = 'btn-async'; 
                invokeAsyncBtn.title = 'Ejecuci√≥n as√≠ncrona (devuelve ID de tarea).';
                invokeAsyncBtn.onclick = () => promptInvoke(name, 'async');
                actionsCell.appendChild(invokeAsyncBtn);
                
                // Bot√≥n Ver Logs
                const logsBtn = document.createElement('button');
                logsBtn.textContent = 'Ver Logs';
                logsBtn.className = 'btn-logs'; 
                logsBtn.onclick = () => showLogs(name); 
                actionsCell.appendChild(logsBtn);

                // Bot√≥n Borrar
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Borrar';
                deleteBtn.className = 'btn-delete';
                deleteBtn.onclick = () => deleteFunction(name);
                actionsCell.appendChild(deleteBtn);
            }
        })
        .catch(error => logToConsole(`Error al listar funciones: ${error.message}`, 'error', '', 'LIST_ERROR'));
    }

    function deleteFunction(funcName) {
        if (!confirm(`¬øEst√°s seguro de que quieres borrar la funci√≥n: ${funcName}?`)) {
            return;
        }

        fetch(`/admin/functions/${funcName}`, {
            method: 'DELETE',
            headers: { 'Authorization': authHeader }
        })
        .then(response => {
            if (response.ok) {
                logToConsole(`Funci√≥n ${funcName} eliminada con √©xito.`, 'success', funcName, 'DELETE_RESULT');
                listFunctions(); 
                getServerStatus();
                listAsyncTasks(); 
            } else {
                return response.json().then(data => {
                    logToConsole(`Error al eliminar: ${data.message || response.statusText}`, 'error', funcName, 'DELETE_ERROR');
                });
            }
        })
        .catch(error => logToConsole(`Error de conexi√≥n al eliminar: ${error.message}`, 'error', funcName, 'DELETE_ERROR'));
    }
    
    function promptInvoke(funcName, mode) { 
        const argsInput = prompt(`Invocar ${funcName} en modo ${mode.toUpperCase()}.\nIngresa los argumentos como array JSON:\nEj: [10, 5, "test"]`, '[]');
        if (argsInput === null) return;

        let processedArgs = [];
        try {
            processedArgs = JSON.parse(argsInput);
            if (!Array.isArray(processedArgs)) {
                throw new Error("El input no es un array JSON v√°lido.");
            }
        } catch (e) {
            logToConsole(`Error al parsear JSON de argumentos: ${e.message}`, 'error', funcName, 'INVOKE_ERROR');
            alert(`Error de formato en los argumentos: ${e.message}`);
            return;
        }
        
        logToConsole({ action: `Invocando (${mode.toUpperCase()})`, args: processedArgs }, 'info', funcName, 'INVOKE'); 

        if (mode === 'sync') {
            invokeFunctionSync(funcName, processedArgs);
        } else if (mode === 'async') {
            invokeFunctionAsync(funcName, processedArgs);
        }
    }

    function invokeFunctionSync(funcName, processedArgs) {
        fetch(`/function/sync/${funcName}`, {
            method: 'POST',
            headers: {
                'Authorization': authHeader,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ args: processedArgs })
        })
        .then(response => response.json())
        .then(data => {
            let logType = data.status === 'success' ? 'success' : 'error';
            
            alert(`Respuesta de la API para ${funcName} (SYNC):\n\n` + JSON.stringify(data, null, 2));

            logToConsole(data, logType, funcName, 'INVOKE_SYNC_RESULT'); 
        })
        .catch(error => {
            logToConsole(`Error de conexi√≥n al invocar: ${error.message}`, 'error', funcName, 'INVOKE_SYNC_ERROR');
            alert('Error al invocar la funci√≥n de forma s√≠ncrona. Revisa la consola y la conexi√≥n.');
        });
    }

    function invokeFunctionAsync(funcName, processedArgs) {
        fetch(`/function/async/${funcName}`, {
            method: 'POST',
            headers: {
                'Authorization': authHeader,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ args: processedArgs })
        })
        .then(response => response.json())
        .then(data => {
            let logType = data.status === 'queued' ? 'queued' : 'info'; 
            
            alert(`Respuesta de la API para ${funcName} (ASYNC):\n\nTarea en cola. ID: ${data.task_id}\nURL de Estado: ${data.check_status_url}\n\nNota: La ejecuci√≥n se realiza en segundo plano.`);

            logToConsole(data, logType, funcName, 'INVOKE_ASYNC_QUEUED'); 
            
            listAsyncTasks();
        })
        .catch(error => {
            logToConsole(`Error de conexi√≥n al invocar as√≠ncrono: ${error.message}`, 'error', funcName, 'INVOKE_ASYNC_ERROR');
            alert('Error al iniciar la funci√≥n as√≠ncrona. Revisa la consola y la conexi√≥n.');
        });
    }

    // =======================================================
    // 3. MONITORIZACI√ìN DE TAREAS AS√çNCRONAS
    // =======================================================

    function listAsyncTasks() {
        fetch('/admin/status', { 
            headers: { 'Authorization': authHeader }
        })
        .then(response => response.json())
        .then(data => {
            const taskListBody = document.getElementById('async-tasks-list');
            taskListBody.innerHTML = '';
            
            const tasks = data.async_tasks_list || []; 
            logToConsole(`Tareas as√≠ncronas cargadas: ${tasks.length} tareas.`, 'info', '', 'TASK_LIST_FETCH');

            getServerStatus(); 

            if (tasks.length === 0) {
                const row = taskListBody.insertRow();
                // Aumentamos el colspan a 6 (antes 5) por la nueva columna
                row.insertCell(0).colSpan = 6; 
                row.cells[0].textContent = 'No hay tareas as√≠ncronas activas o registradas.';
                return;
            }

            tasks.forEach(task => {
                const row = taskListBody.insertRow();
                const statusClass = task.status; 
                
                // Muestra el ID completo
                row.insertCell().textContent = task.task_id; 
                row.insertCell().textContent = task.function_name;
                
                const statusCell = row.insertCell();
                statusCell.innerHTML = `<strong class="${statusClass}">${task.status.toUpperCase()}</strong>`;
                
                row.insertCell().textContent = task.time_start || 'N/A';
                
                // üöÄ CAMBIO CLAVE: Celdas para el tiempo de fin
                const timeEndCell = row.insertCell();
                timeEndCell.textContent = task.time_end || (task.status === 'running' ? 'En curso...' : 'N/A');
                
                const actionsCell = row.insertCell();

                // Bot√≥n ic√≥nico de Actualizar Estado
                const checkStatusBtn = document.createElement('button');
                checkStatusBtn.textContent = 'üîÑ'; // Icono de refresh
                checkStatusBtn.className = 'btn-icon'; // Nueva clase para tama√±o
                checkStatusBtn.title = 'Actualizar Estado';
                checkStatusBtn.onclick = () => checkTaskStatus(task.task_id, true);
                actionsCell.appendChild(checkStatusBtn);

                // Bot√≥n ic√≥nico para ver el resultado
                if (task.status === 'completed' || task.status === 'failed') {
                    const resultBtn = document.createElement('button');
                    resultBtn.textContent = 'üëÅÔ∏è'; // Icono de ojo/visualizaci√≥n
                    resultBtn.className = (task.status === 'completed' ? 'btn-logs' : 'btn-delete') + ' btn-icon';
                    resultBtn.title = 'Ver Resultado';
                    resultBtn.onclick = () => checkTaskStatus(task.task_id, true); 
                    actionsCell.appendChild(resultBtn);
                }
            });
        })
        .catch(error => logToConsole(`Error al listar tareas as√≠ncronas: ${error.message}`, 'error', '', 'TASK_LIST_ERROR'));
    }

    function checkTaskStatus(taskId, forceAlert = false) {
        fetch(`/task/status/${taskId}`, {
            method: 'GET',
            headers: { 'Authorization': authHeader }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'running' || data.status === 'queued') {
                logToConsole(`Estado de tarea ${taskId}: ${data.status}.`, data.status, data.function_name, 'TASK_STATUS');
                if (forceAlert) {
                     alert(`Estado de la Tarea ${taskId}:\n\nEstado: ${data.status.toUpperCase()}\n\nNota: La ejecuci√≥n a√∫n no ha finalizado. Presione "Recargar Tareas" o espere un momento.`);
                }
            } else if (data.status === 'completed' || data.status === 'failed') {
                const logType = data.status; 
                logToConsole(`Tarea ${taskId} FINALIZADA con estado ${data.status}.`, logType, data.function_name, 'TASK_COMPLETED');
                
                // Resaltar el resultado/error
                let keyInfo;
                if (data.status === 'completed') {
                    keyInfo = `‚úÖ RESULTADO: \n${JSON.stringify(data.result, null, 2)}`;
                } else {
                    keyInfo = `‚ùå ERROR: \n${data.error}`;
                }
                
                alert(`üìã **Resultado Final de Tarea As√≠ncrona**\n\n` + 
                      `Funci√≥n: ${data.function_name}\n` +
                      `Estado: ${data.status.toUpperCase()}\n` +
                      `ID Tarea: ${taskId}\n` +
                      `Tiempo Inicio: ${data.time_start || 'N/A'}\n` +
                      `Tiempo Fin: ${data.time_end || 'N/A'}\n\n` + // üöÄ A√±adido al alerta
                      `---------------------------\n` +
                      keyInfo);
                
                listFunctions(); 
                listAsyncTasks(); 
            } else {
                 logToConsole(`Estado de tarea ${taskId}: desconocido.`, 'warning', data.function_name, 'TASK_STATUS_UNKNOWN');
            }
            
            if (forceAlert) {
                 listAsyncTasks(); 
            }
        })
        .catch(error => {
            logToConsole(`Error al comprobar el estado de la tarea ${taskId}: ${error.message}`, 'error', '', 'TASK_STATUS_ERROR');
        });
    }

    // Borrar todas las tareas del panel
    function clearAllAsyncTasks() {
        if (!confirm("¬øEst√° seguro de que desea borrar TODAS las tareas as√≠ncronas del panel de visualizaci√≥n? (Esto borrar√° el registro de tareas en memoria)")) {
            return;
        }

        fetch('/admin/clear_tasks', {
            method: 'POST',
            headers: { 'Authorization': authHeader }
        })
        .then(response => response.json().then(data => {
            if (response.ok) {
                logToConsole(data.message, 'success', '', 'TASK_CLEAR_ALL');
                listAsyncTasks(); 
                getServerStatus();
            } else {
                throw new Error(data.message || 'Error al borrar tareas.');
            }
        }))
        .catch(error => logToConsole(`Fallo al borrar tareas: ${error.message}`, 'error', '', 'TASK_CLEAR_ERROR'));
    }

    // =======================================================
    // 4. FUNCI√ìN PARA MOSTRAR LOGS
    // =======================================================

    function showLogs(funcName) {
        const apiUrl = `/admin/logs/${funcName}`;
        logToConsole(`Solicitando logs...`, 'info', funcName, 'LOGS_FETCH'); 

        fetch(apiUrl, {
            method: 'GET',
            headers: { 'Authorization': authHeader }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || `Error ${response.status} en la API.`);
                });
            }
            return response.json();
        })
        .then(logs => {
            displayLogs(funcName, logs);
        })
        .catch(error => {
            logToConsole(`Fallo al obtener logs: ${error.message}`, 'error', funcName, 'LOGS_ERROR'); 
            alert('Error al obtener los logs: ' + error.message);
        });
    }

    function displayLogs(funcName, logs) {
        if (logs.status === 'error' || logs.length === 0) {
            logToConsole(`No se encontraron logs de ejecuci√≥n.`, 'warning', funcName, 'LOGS_RESULT');
            alert(`Logs para "${funcName}": No se encontraron logs de ejecuci√≥n.`);
            return;
        }

        let logContent = `Logs completos de la API para: ${funcName}\n\n`;
        const recentLogs = logs.slice(-5); 
        
        logToConsole(`Logs recibidos (${recentLogs.length} recientes)`, 'info', funcName, 'LOGS_RESULT');

        recentLogs.forEach((entry, index) => {
            logContent += `--- Ejecuci√≥n #${logs.length - recentLogs.length + index + 1} ---\n`;
            logContent += JSON.stringify(entry, null, 2);
            logContent += '\n\n';

            const logType = entry.status === 'success' ? 'success' : 'error';
            logToConsole(entry, logType, funcName, 'LOG_ENTRY'); 
        });

        alert(logContent);
    }
</script>

</body>
</html>